name: "Deploy to GKE"

on:
  push:
    branches: [ "main" ]
    paths:
      - 'k8s/**'
  workflow_dispatch:

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  deploy:
    name: "Deploy to GKE"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: "${{ secrets.GCP_WIF_PROVIDER }}"
        service_account: "${{ secrets.GCP_SERVICE_ACCOUNT }}"
        project_id: "${{ secrets.GCP_PROJECT_ID }}"

    - name: Get GKE Credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: "${{ secrets.GCP_CLUSTER_NAME }}"
        location: "${{ secrets.GCP_REGION }}-a"
        project_id: "${{ secrets.GCP_PROJECT_ID }}"

    - name: Deploy to GKE
      run: |
        kubectl apply -f k8s/sample-app/
        kubectl rollout status deployment/sample-app --timeout=60s

    - name: Get Service IP
      run: |
        echo "Waiting for LoadBalancer IP..."
        sleep 30
        kubectl get svc sample-app -o jsonpath='{.status.loadBalancer.ingress[0].ip}'
