name: "Deploy to GKE (Canary)"

on:
  push:
    branches: [ "main" ]
    paths:
      - 'k8s/**'
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (e.g., v1.0.0)'
        required: false
        default: ''

permissions:
  contents: 'read'
  id-token: 'write'

jobs:
  deploy:
    name: "Deploy to GKE"
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        workload_identity_provider: "${{ secrets.GCP_WIF_PROVIDER }}"
        service_account: "${{ secrets.GCP_SERVICE_ACCOUNT }}"
        project_id: "${{ secrets.GCP_PROJECT_ID }}"

    - name: Get GKE Credentials
      uses: google-github-actions/get-gke-credentials@v2
      with:
        cluster_name: "${{ secrets.GCP_CLUSTER_NAME }}"
        location: "${{ secrets.GCP_REGION }}-a"
        project_id: "${{ secrets.GCP_PROJECT_ID }}"

    - name: Install Argo Rollouts CLI
      run: |
        curl -LO https://github.com/argoproj/argo-rollouts/releases/latest/download/kubectl-argo-rollouts-linux-amd64
        chmod +x kubectl-argo-rollouts-linux-amd64
        sudo mv kubectl-argo-rollouts-linux-amd64 /usr/local/bin/kubectl-argo-rollouts

    - name: Deploy Rollout
      run: |
        kubectl apply -f k8s/sample-app/ -n app

    - name: Update Image (if specified)
      if: ${{ github.event.inputs.image_tag != '' }}
      run: |
        kubectl argo rollouts set image sample-app nginx=${{ secrets.DOCKERHUB_USERNAME }}/sample-app:${{ github.event.inputs.image_tag }} -n app

    - name: Watch Rollout Status
      run: |
        kubectl argo rollouts status sample-app --timeout=300s -n app 

    - name: Get Rollout Info
      if: always()
      run: |
        echo "### Rollout Status" >> $GITHUB_STEP_SUMMARY
        kubectl argo rollouts get rollout sample-app -n app

    - name: Deployment Info
      run: |
        echo "### Service Endpoints" >> $GITHUB_STEP_SUMMARY
        echo "Check GCP Load Balancer IP in Console" >> $GITHUB_STEP_SUMMARY
